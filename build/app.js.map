{"version":3,"sources":["app.ts"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["/*\nCopyright 2016 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// Import most things with types if possible.\nimport Opts = require('node-getopt');\nimport * as express from 'express';\nimport * as bodyParser from 'body-parser';\nimport * as _ from 'lodash';\nimport * as Promise from 'bluebird';\nimport * as GithubBot from './githubbot';\nimport * as crypto from 'crypto';\n\n// Arguments determine which bot type we want to use.\nconst getopt = new Opts([\n\t[ 'b',\t'bot-names=ARG+',\t'Determines which bots will run'],\n\t[ 'h',\t'help',\t\t\t\t'This help message']\n]);\n\ngetopt.setHelp(`\nUsage: ${process.argv[1].split('/').slice(-1)} [OPTION]\n[[OPTIONS]]\n`);\n\n// No options, no run.\nconst opt = getopt.parse(process.argv.slice(2))\nif (opt.options['help'] || Object.keys(opt.options).length === 0) {\n\tconsole.log(getopt.getHelp());\n\tprocess.exit(0)\n}\n\n// Verify that events being sent our way are valid and authenticated.\nfunction verifyWebhookToken(payload: string, hubSignature: string) {\n\tconst newHmac: any = crypto.createHmac('sha1', process.env.WEBHOOK_SECRET);\n\tnewHmac.update(payload);\n\tif (('sha1=' + newHmac.digest('hex')) === hubSignature) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// Standard Express installation.\nconst app = express();\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json());\n\n// Import any specified bots. These will all listen for webhooks.\nlet botRegistry: GithubBot.GithubBot[] = [];\nfor (let bot of opt.options['bot-names']) {\n\t// Dynamically require the bots.\n\ttry {\n\t\tlet importedBot = require(`./${bot}`);\n\t\tbotRegistry.push(importedBot.createBot());\n\t\tconsole.log(`Imported ${bot}...`)\n\t} catch (err) {\n\t\tconsole.log(`Could not import bot type ${bot}`);\n\t\tconsole.log(err);\n\t\tthrow err;\n\t}\n}\n\n// Run the hook listener now, and for each bot we've been asked to listen\n// to, wait for events. When we get an event, check against those bots\n// registered, and send filtered messages on to them for action.\napp.post('/webhooks', (req: any, res: any) => {\n\tconst eventType: string = req.get('x-github-event');\n\tconst payload = req.body;\n\n\tif (req.get('x-hub-signature'))\n\n\t// Ensure that the sender is authorised and uses our secret.\n\tif (!verifyWebhookToken(JSON.stringify(payload), req.get('x-hub-signature'))) {\n\t\tres.sendStatus(401);\n\t\treturn;\n\t}\n\n\t// Let the hook get on with it.\n\tres.sendStatus(200);\n\n\t// Go through all registered bots, and send them any appropriate hook.\n\t_.forEach(botRegistry, (bot: GithubBot.GithubBot) => {\n\t\tbot.firedEvent(eventType, payload);\n\t});\n});\n\n// Listen on 4567 for the moment.\napp.listen(4567, () => {\n\tconsole.log('Listening for Github Integration hooks on port 4567.');\n});"],"sourceRoot":"../lib"}