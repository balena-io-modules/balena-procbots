{"version":3,"sources":["bots/syncbot.ts"],"names":[],"mappings":"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","file":"syncbot.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport * as _ from 'lodash';\nimport { ProcBot } from '../framework/procbot';\nimport { Messenger } from '../services/messenger';\nimport {\n    DataHub,\n    FlowDefinition,\n    InterimContext, MessengerAction,\n    MessengerContext,\n    TransmitContext,\n} from '../services/messenger-types';\nimport {\n    ServiceEvent,\n    ServiceListenerMethod,\n    ServiceRegistration,\n} from '../services/service-types';\nimport { LogLevel } from '../utils/logger';\n\nexport class SyncBot extends ProcBot {\n    // These objects store built objects, typed and indexed, to help minimise object rebuilding\n    private messengers = new Map<string, Messenger>();\n    private hub: DataHub;\n\n    /**\n     * Creates a SyncBot using SYNCBOT_MAPPINGS and SYNCBOT_HUB_SERVICE from the environment.\n     * @param name  identifier for this bot, defaults to SyncBot.\n     */\n    constructor(name = 'SyncBot') {\n        super(name);\n        // Register each edge in the mappings array bidirectionally\n        const mappings: FlowDefinition[][] = JSON.parse(process.env.SYNCBOT_MAPPINGS);\n        for(const mapping of mappings) {\n            let priorFlow = null;\n            for(const focusFlow of mapping) {\n                if(priorFlow) {\n                    this.register(priorFlow, focusFlow);\n                    this.register(focusFlow, priorFlow);\n                }\n                priorFlow = focusFlow;\n            }\n        }\n    }\n\n    /**\n     * Awaken services and register the event processors.\n     * @param from  Definition of a flow to listen to.\n     * @param to    Definition of a flow to emit to.\n     */\n    private register(from: FlowDefinition, to: FlowDefinition) {\n        try {\n            // Ensure that the adapters are running\n            const fromConstructor = JSON.parse(process.env[`SYNCBOT_${from.service.toUpperCase()}_CONSTRUCTOR_OBJECT`]);\n            const toConstructor = JSON.parse(process.env[`SYNCBOT_${to.service.toUpperCase()}_CONSTRUCTOR_OBJECT`]);\n            this.addServiceListener(from.service, fromConstructor);\n            this.addServiceEmitter(from.service, fromConstructor);\n            const listener = this.getListener(from.service);\n            this.addServiceEmitter(to.service, toConstructor);\n            if (listener) {\n                // Listen to and handle events\n                listener.registerEvent({\n                    events: [this.getMessageService(from.service, fromConstructor).translateEventName('message')],\n                    listenerMethod: this.createRouter(from, to),\n                    name: `${from.service}:${from.flow}=>${to.service}:${to.flow}`,\n                });\n            }\n        } catch (error) {\n            this.logger.log(\n                LogLevel.WARN,\n                `Problem creating link from ${from.service} to ${to.service}: ${error.message}`,\n            );\n        }\n    }\n\n    /**\n     * Create a function that will route a data payload to the specified room.\n     * @param from  Definition of a flow to listen to.\n     * @param to    Definition of a flow to emit to.\n     * @returns     function that routes the payload.\n     */\n    private createRouter(from: FlowDefinition, to: FlowDefinition): ServiceListenerMethod {\n        // This function returns a function, watch out!\n        return (_registration: ServiceRegistration, data: ServiceEvent): Promise<void> => {\n            // Convert the raw payload from the listener into a more generic message object\n            return this.getMessageService(from.service).makeGeneric(data).then((generic) => {\n                // Check that the payload is in a flow we care about and not destined for somewhere it already is\n                if (generic.sourceIds.flow === from.flow\n                    && _.intersection([generic.source, generic.genesis], ['system', to.service]).length === 0\n                ) {\n                    // Transmute the receipt object into an intermediary form, providing flow id to initialise\n                    const event = Messenger.initInterimContext(generic, to.service, {flow: to.flow});\n                    // Attempt to find a connected thread\n                    return this.useConnected(event, 'thread')\n                    .then(() => {\n                        // Attempt to find account details for the user\n                        this.useProvided(event, 'user')\n                        .then(() => this.useHubOrGeneric(event, 'token'))\n                        // Attempt to emit the event, massaging it first into a final form\n                        .then(() => this.create(event as TransmitContext))\n                        // Emit the status of the synchronise, console and in-app\n                        .then(() => this.logSuccess(event as TransmitContext))\n                        .catch((error: Error) => this.handleError(error, event));\n                    })\n                    .catch(() => {\n                        // Attempt to find account details for the user\n                        this.useProvided(event, 'user')\n                        .then(() => this.useHubOrGeneric(event, 'token'))\n                        // Attempt to emit the event and record the connection\n                        .then(() => this.create(event as TransmitContext))\n                        .then(() => this.createConnection(event, 'thread'))\n                        // Emit the status of the synchronise, console and in-app\n                        .then(() => this.logSuccess(event as TransmitContext))\n                        .catch((error: Error) => this.handleError(error, event));\n                    });\n                }\n                // We have performed all appropriate routing, ie none\n                return Promise.resolve();\n            });\n        };\n    }\n\n    /**\n     * Report an error back to the source of the event.\n     * @param error  error to report.\n     * @param event  source event that should be reflected into target context.\n     */\n    private handleError(error: Error, event: InterimContext): void {\n        // Put this on the log service\n        this.logger.log(LogLevel.WARN, error.message);\n        this.logger.log(LogLevel.WARN, JSON.stringify(event));\n        // Create a message event to echo with the details\n        const fromEvent: InterimContext = {\n            action: MessengerAction.Create,\n            first: false,\n            genesis: 'system',\n            hidden: true,\n            source: 'system',\n            sourceIds: {\n                flow: '',\n                message: '',\n                thread: '',\n                user: '',\n            },\n            // Format the report for slight user-friendliness\n            text: `${event.to} reports \\`${error.message}\\``,\n            // Reflect the source as the to\n            to: event.source,\n            toIds: {\n                flow: event.sourceIds.flow,\n                thread: event.sourceIds.thread,\n            },\n        };\n        // Find the system account details\n        this.useSystem(fromEvent, 'user')\n        .then(() => this.useSystem(fromEvent, 'token'))\n        // Report the error\n        .then(() => this.create(fromEvent as TransmitContext))\n        .then(() => this.logSuccess(fromEvent as TransmitContext))\n        .catch((err) => this.logError(err, event));\n    }\n\n    /**\n     * Retrieve or create a service that can understand the generic message format.\n     * @param key   Name of the service to seek.\n     * @param data  Instantiation data for the service.\n     * @returns     Object which implements the generic message abstract.\n     */\n    private getMessageService(key: string, data?: any): Messenger {\n        // Attempt to retrieve and return the existing messenger\n        const retrieved = this.messengers.get(key);\n        if (retrieved) {\n            return retrieved;\n        }\n        // Create, stash and return a new messenger\n        const service = require(`../services/${key}`);\n        const created = service.createMessageService(data);\n        this.messengers.set(key, created);\n        return created;\n    }\n\n    /**\n     * Retrieve or create a data hub that can retrieve a user's data.\n     * @param key   Name of the hub to seek.\n     * @param data  Instantiation data for the hub.\n     * @returns     Object which implements the data hub abstract.\n     */\n    private getDataHub(key: string, data?: any): DataHub {\n        if (!this.hub) {\n            const service = require(`../services/${key}`);\n            this.hub = service.createDataHub(data);\n        }\n        return this.hub;\n    }\n\n    /**\n     * Connect two threads with comments about each other.\n     * @param event  Event with the two threads specified.\n     * @param type   What to connect, must be thread.\n     * @returns      Resolves when connection is stored.\n     */\n    private createConnection(event: InterimContext, type: 'thread'): Promise<void> {\n        // Find details of the threads to pair\n        const sourceId = event.sourceIds.thread;\n        const toId = event.toIds.thread;\n        if (!sourceId || !toId) {\n            return Promise.reject(new Error(`Could not form ${type} connection`));\n        }\n        // Create a mutual common object for later tweaks\n        const genericEvent: InterimContext = {\n            action: MessengerAction.Create,\n            first: false,\n            genesis: 'system',\n            hidden: true,\n            source: 'system',\n            // System message, so not relevant\n            sourceIds: {\n                flow: '',\n                message: '',\n                thread: '',\n                user: '',\n            },\n            // These get adjusted before use\n            text: 'duff',\n            to: 'duff',\n            toIds: {},\n        };\n        // Clone and tweak to form requests for two services\n        const toEvent = _.cloneDeep(genericEvent);\n        toEvent.text = `[Connects to ${event.source} ${type} ${sourceId}](${event.sourceIds.url})`;\n        toEvent.to = event.to;\n        toEvent.toIds = event.toIds;\n        const fromEvent = _.cloneDeep(genericEvent);\n        fromEvent.text = `[Connects to ${event.to} ${type} ${toId}](${event.toIds.url})`;\n        fromEvent.to = event.source;\n        fromEvent.toIds = event.sourceIds;\n        // Dispatch these events, simplifying the resolutions\n        return Promise.all([\n            this.useSystem(fromEvent, 'user')\n            .then(() => this.useSystem(fromEvent, 'token'))\n            .then(() => this.create(fromEvent as TransmitContext))\n            .then(() => this.logSuccess(fromEvent as TransmitContext))\n            ,\n            this.useSystem(toEvent, 'user')\n            .then(() => this.useSystem(toEvent, 'token'))\n            .then(() => this.create(toEvent as TransmitContext))\n            .then(() => this.logSuccess(toEvent as TransmitContext))\n        ]).reduce(() => { /**/ });\n    }\n\n    /**\n     * Pass a transmission context to the emitter.\n     * @param event  Standardised transmission context to emit.\n     * @returns      Promise that will resolve to the id of the created message.\n     */\n    private create(event: TransmitContext): Promise<string> {\n        // Pass the event to the emitter\n        return this.getMessageService(event.to).makeSpecific(event).then((specific) => {\n            return this.dispatchToEmitter(event.to, {\n                contexts: {\n                    // Translating the message event into the specific form for the emitter\n                    [event.to]: specific\n                },\n                source: event.source\n            })\n            .then((retVal) => {\n                // Store and return the created id\n                event.toIds.message = retVal.response.message;\n                event.toIds.thread = retVal.response.thread;\n                event.toIds.url = retVal.response.url;\n                return retVal.response.message;\n            });\n        });\n    }\n\n    /**\n     * Record to the console some details from the event.\n     * @param event  Event to record, will only pass on safe information.\n     */\n    private logSuccess(event: TransmitContext): void {\n        const output = {source: event.source, title: event.title, text: event.text, target: event.to};\n        this.logger.log(LogLevel.INFO, `Synced: ${JSON.stringify(output)}`);\n    }\n\n    /**\n     * This should be called when something really goes wrong, and in-app reports fail.\n     * @param error  Error to report.\n     * @param event  Event that caused the error.\n     */\n    private logError(error: Error, event: MessengerContext): void {\n        // Do what we can to make this event obvious in the logs\n        this.logger.log(LogLevel.WARN, 'v!!!v');\n        this.logger.log(LogLevel.WARN, error.message);\n        this.logger.log(LogLevel.WARN, JSON.stringify(event));\n        this.logger.log(LogLevel.WARN, '^!!!^');\n    }\n\n    private useHubOrGeneric(event: InterimContext, type: 'token'): Promise<string> {\n        return this.useHub(event, type)\n        .catch(() => this.useGeneric(event, type))\n        .catchThrow(new Error(`Could not find hub or generic ${type} for ${event.to}`));\n    }\n\n    /**\n     * Use the source to provide the detail requested.\n     * @param event  Event to scrutinise and mutate.\n     * @param type   property to search for, must be 'user'.\n     * @returns      Resolves to the found property.\n     */\n    private useProvided(event: InterimContext, type: 'user'): Promise<string> {\n        return new Promise<string>((resolve) => {\n            // Look in the existing object\n            if (!event.sourceIds[type]) {\n                throw new Error(`Could not find provided ${type} for ${event.to}`);\n            }\n            event.toIds[type] = event.sourceIds[type];\n            resolve(event.toIds[type]);\n        });\n    }\n\n    private useGeneric(event: InterimContext, type: 'user'|'token'): Promise<string> {\n        return new Promise<string>((resolve) => {\n            // Try to find the value specified\n            const to = event.to;\n            const genericAccounts = JSON.parse(process.env.SYNCBOT_GENERIC_AUTHOR_ACCOUNTS);\n            if (!genericAccounts[to] || !genericAccounts[to][type]) {\n                throw new Error(`Could not find generic ${type} for ${event.to}`);\n            }\n            event.toIds[type] = genericAccounts[to][type];\n            resolve(genericAccounts[to][type]);\n        });\n    }\n\n    /**\n     * Use the environment SYNCBOT_SYSTEM_MESSAGE_ACCOUNTS to provide the detail requested.\n     * @param event  Event to scrutinise and mutate.\n     * @param type   property to search for, must be 'user' or 'token'.\n     * @returns      Resolves to the found property.\n     */\n    private useSystem(event: InterimContext, type: 'user'|'token'): Promise<string> {\n        return new Promise<string>((resolve) => {\n            // Try to find the value specified\n            const to = event.to;\n            const systemAccounts = JSON.parse(process.env.SYNCBOT_SYSTEM_MESSAGE_ACCOUNTS);\n            if (!systemAccounts[to] || !systemAccounts[to][type]) {\n                throw new Error(`Could not find system ${type} for ${event.to}`);\n            }\n            event.toIds[type] = systemAccounts[to][type];\n            resolve(systemAccounts[to][type]);\n        });\n    }\n\n    /**\n     * Use the thread history to provide the detail requested.\n     * @param event  Event to scrutinise and mutate.\n     * @param type   property to search for, must be 'thread'.\n     * @returns      Resolves to the found property.\n     */\n    private useConnected(event: InterimContext, type: 'thread'): Promise<string> {\n        // Check the pretext; then capture the id text (roughly speaking include base64, exclude html tag)\n        const findBase = `Connects to ${event.to} ${type}`;\n        const findId = new RegExp(`${findBase} ([\\\\w\\\\d-+\\\\/=]+)`, 'i');\n        // Retrieve from the message service search a filtered thread history\n        const messageService = this.getMessageService(event.source);\n        return messageService.fetchNotes(event.sourceIds.thread, event.sourceIds.flow, findId, findBase)\n        .then((result) => {\n            // If we found any comments from the messageService, reduce them to the first id\n            const ids = result && result.length > 0 && result[0].match(findId);\n            if (ids && ids.length > 0) {\n                event.toIds.thread = ids[1];\n                return ids[1];\n            }\n            throw new Error(`Could not find connected ${type} for ${event.to}`);\n        });\n    }\n\n    /**\n     * Use the hub service to provide the detail requested.\n     * @param event  Event to scrutinise and mutate.\n     * @param type   property to search for, must be 'token'.\n     * @returns      Resolves to the found property.\n     */\n    private useHub(event: InterimContext, type: 'token'): Promise<string> {\n        let user: string | undefined = undefined;\n        if (event.source === process.env.SYNCBOT_HUB_SERVICE) {\n            user = event.sourceIds.user;\n        } else if (event.to === process.env.SYNCBOT_HUB_SERVICE) {\n            user = event.toIds.user;\n        }\n        if (user) {\n            try {\n                const hubName = process.env.SYNCBOT_HUB_SERVICE;\n                const hubConstructor = JSON.parse(process.env[`SYNCBOT_${hubName.toUpperCase()}_CONSTRUCTOR_OBJECT`]);\n                return this.getDataHub(hubName, hubConstructor).fetchValue(user, `${event.to} ${type}`)\n                .then((value) => {\n                    event.toIds[type] = value;\n                    return value;\n                })\n                .catch(() => {\n                    throw new Error(`Could not find hub ${type} for ${event.to}`);\n                });\n            } catch (error) {\n                return Promise.reject(error);\n            }\n        } else {\n            return Promise.reject(new Error(`Could not find hub ${type} for ${event.to}`));\n        }\n    }\n}\n\nexport function createBot(): SyncBot {\n    return new SyncBot(process.env.SYNCBOT_NAME);\n}\n"],"sourceRoot":"../../lib"}