{"version":3,"sources":["bots/syncbot.ts"],"names":[],"mappings":"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","file":"syncbot.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport * as _ from 'lodash';\nimport { ProcBot } from '../framework/procbot';\nimport { MessengerService } from '../services/messenger';\nimport {\n\tFlowDefinition, MessageEmitResponse, MessageEvent, MessageInformation, MessageListenerMethod, TransmitInformation,\n} from '../services/messenger-types';\nimport { createDataHub } from '../services/messenger/datahubs/datahub';\nimport { Logger, LogLevel } from '../utils/logger';\n\nexport class SyncBot extends ProcBot {\n\tprivate static makeRouter(\n\t\tfrom: FlowDefinition, to: FlowDefinition, emitter: MessengerService, logger: Logger\n\t): MessageListenerMethod {\n\t\treturn (_registration, event: MessageEvent) => {\n\t\t\tconst data = event.cookedEvent;\n\t\t\tif (\n\t\t\t\tfrom.service === data.source.service &&\n\t\t\t\tfrom.flow === data.source.flow &&\n\t\t\t\tdata.details.genesis !== 'system'\n\t\t\t) {\n\t\t\t\tconst text = data.details.text;\n\t\t\t\tlogger.log(LogLevel.INFO, `---> Heard '${text}' on ${from.service}.`);\n\t\t\t\treturn SyncBot.createThreadAndConnect(from, to, emitter, data)\n\t\t\t\t.then(() => {\n\t\t\t\t\tlogger.log(LogLevel.INFO, `---> Emitted '${text}' to ${to.service}.`);\n\t\t\t\t});\n\t\t\t}\n\t\t\t// The event received doesn't match the profile being routed, so no-op is the correct action.\n\t\t\treturn Promise.resolve();\n\t\t};\n\t}\n\n\tprivate static createThreadAndConnect(\n\t\tfrom: FlowDefinition, to: FlowDefinition, emitter: MessengerService, data: MessageInformation\n\t): Promise<MessageEmitResponse> {\n\t\tconst createThread: TransmitInformation = {\n\t\t\taction: 'createThread',\n\t\t\tdetails: data.details,\n\t\t\thub: {\n\t\t\t\tusername: data.source.username,\n\t\t\t},\n\t\t\tsource: data.source,\n\t\t\ttarget: {\n\t\t\t\tflow: to.flow,\n\t\t\t\tservice: to.service,\n\t\t\t\tusername: data.source.username,\n\t\t\t},\n\t\t};\n\n\t\tconst createConnections: TransmitInformation = {\n\t\t\taction: 'createComment',\n\t\t\tdetails: {\n\t\t\t\tgenesis: 'system',\n\t\t\t\thidden: true,\n\t\t\t\tinternal: true,\n\t\t\t\ttext: 'This ticket is mirrored in ' // will be appended\n\t\t\t},\n\t\t\thub: {\n\t\t\t\tusername: process.env.SYNCBOT_NAME,\n\t\t\t},\n\t\t\tsource: { // this message is being created from nothing\n\t\t\t\tmessage: 'duff',\n\t\t\t\tthread: 'duff',\n\t\t\t\tflow: 'duff',\n\t\t\t\tservice: 'system',\n\t\t\t\tusername: 'duff',\n\t\t\t},\n\t\t\ttarget: {\n\t\t\t\tflow: 'duff', // will be replaced\n\t\t\t\tservice: 'duff', // will be replaced\n\t\t\t\tusername: process.env.SYNCBOT_NAME,\n\t\t\t\tthread: 'duff' // will be replaced\n\t\t\t}\n\t\t};\n\n\t\treturn emitter.sendData({\n\t\t\tcontexts: {\n\t\t\t\tmessenger: createThread,\n\t\t\t},\n\t\t\tsource: 'syncbot',\n\t\t}).then((emitResponse: MessageEmitResponse) => {\n\t\t\tconst response = emitResponse.response;\n\t\t\tif (response) {\n\t\t\t\tconst connectTarget = _.cloneDeep(createConnections);\n\t\t\t\tconnectTarget.target = {\n\t\t\t\t\tflow: data.source.flow,\n\t\t\t\t\tservice: data.source.service,\n\t\t\t\t\tusername: process.env.SYNCBOT_NAME,\n\t\t\t\t\tthread: data.source.thread,\n\t\t\t\t};\n\t\t\t\tconnectTarget.details.text += `[${to.service} thread ${response.thread}](${response.url})`;\n\n\t\t\t\tconst sourceDetails = data.source;\n\t\t\t\tconst connectSource = _.cloneDeep(createConnections);\n\t\t\t\tconnectSource.target = {\n\t\t\t\t\tflow: to.flow,\n\t\t\t\t\tservice: to.service,\n\t\t\t\t\tusername: process.env.SYNCBOT_NAME,\n\t\t\t\t\tthread: response.thread,\n\t\t\t\t};\n\t\t\t\tconnectSource.details.text += `[${from.service} thread ${sourceDetails.thread}](${sourceDetails.url})`;\n\n\t\t\t\treturn Promise.all([\n\t\t\t\t\temitter.sendData({contexts: {messenger: connectTarget}, source: 'syncbot'}),\n\t\t\t\t\temitter.sendData({contexts: {messenger: connectSource}, source: 'syncbot'}),\n\t\t\t\t]).return(emitResponse);\n\t\t\t}\n\t\t\treturn Promise.resolve(emitResponse);\n\t\t});\n\t}\n\n\tconstructor(name = 'SyncBot') {\n\t\tsuper(name);\n\t\tconst logger = new Logger();\n\n\t\t// Build the dataHub object\n\t\tconst dataHub = createDataHub(\n\t\t\tprocess.env.SYNCBOT_DATAHUB_SERVICE,\n\t\t\tJSON.parse(process.env.SYNCBOT_DATAHUB_CONSTRUCTOR)\n\t\t);\n\t\tif (!dataHub) {\n\t\t\tthrow new Error('Could not create dataHub.');\n\t\t}\n\t\tconst dataHubs = [\n\t\t\tcreateDataHub('configuration', 'syncbot'),\n\t\t\tdataHub,\n\t\t];\n\n\t\t// Build the messenger object, with the sub-listeners\n\t\tconst messenger = new MessengerService(\n\t\t\t{\n\t\t\t\tdataHubs,\n\t\t\t\tsubServices: JSON.parse(process.env.SYNCBOT_LISTENER_CONSTRUCTORS),\n\t\t\t},\n\t\t\ttrue,\n\t\t);\n\t\tif (!messenger) {\n\t\t\tthrow new Error('Could not create Messenger.');\n\t\t}\n\n\t\t// Register each edge in the mappings array bidirectionally\n\t\tconst mappings: FlowDefinition[][] = JSON.parse(process.env.SYNCBOT_MAPPINGS);\n\t\tfor(const mapping of mappings) {\n\t\t\tlet priorFlow = null;\n\t\t\tfor(const focusFlow of mapping) {\n\t\t\t\tif(priorFlow) {\n\t\t\t\t\tmessenger.registerEvent({\n\t\t\t\t\t\tevents: ['message'],\n\t\t\t\t\t\tlistenerMethod: SyncBot.makeRouter(priorFlow, focusFlow, messenger, logger),\n\t\t\t\t\t\tname: `${priorFlow.service}.${priorFlow.flow}=>${focusFlow.service}.${focusFlow.flow}`,\n\t\t\t\t\t});\n\t\t\t\t\tmessenger.registerEvent({\n\t\t\t\t\t\tevents: ['message'],\n\t\t\t\t\t\tlistenerMethod: SyncBot.makeRouter(focusFlow, priorFlow, messenger, logger),\n\t\t\t\t\t\tname: `${focusFlow.service}.${focusFlow.flow}=>${priorFlow.service}.${priorFlow.flow}`,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tpriorFlow = focusFlow;\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport function createBot(): SyncBot {\n\treturn new SyncBot(process.env.SYNCBOT_NAME);\n}\n"],"sourceRoot":"../../lib"}