{"version":3,"sources":["framework/worker.ts"],"names":[],"mappings":";;AAqCC,CAAC;AAaF;IAaI,YAAY,OAAU,EAAE,MAAoB;QATpC,UAAK,GAAkB,EAAE,CAAC;QAU9B,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;IACzB,CAAC;IAMD,IAAI,OAAO;QACP,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;IACzB,CAAC;IAMM,QAAQ,CAAC,KAAkB;QAC9B,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEvB,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YAC1B,IAAI,CAAC,SAAS,EAAE,CAAC;QACrB,CAAC;IACL,CAAC;IAMO,SAAS;QAEb,MAAM,KAAK,GAAgB,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QAGzC,KAAK,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC;aAC7B,IAAI,CAAC;YACF,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC;YACnB,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;gBACxB,IAAI,CAAC,SAAS,EAAE,CAAC;YACrB,CAAC;YAAC,IAAI,CAAC,CAAC;gBAEJ,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC9B,CAAC;QACL,CAAC,CAAC,CAAC;IACP,CAAC;CACJ;AA1DD,wBA0DC","file":"worker.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport { ServiceEvent } from '../services/service-types';\n\n/**\n * A method called by the Worker class to process an event.\n * @param data  The ServiceEvent to process.\n */\nexport type WorkerMethod = (data: ServiceEvent) => Promise<void>;\n\n/**\n * Remove a worker from a context.\n * @param context   The context in which the Worker should be removed.\n */\nexport type WorkerRemove = <T>(context: T) => void;\n\n/** An event that has fired and needs to be processed. */\nexport interface WorkerEvent {\n    /** The data arising from the event. */\n    data: ServiceEvent;\n    /** The WorkerMethod to use to process the event. */\n    workerMethod: WorkerMethod;\n};\n\n/** Map linking contexts to Worker instances. */\nexport type WorkerMap<T> = Map<T, Worker<T>>;\n\n/**\n * The Worker class is responsible for the execution of scheduling tasks based on events.\n * Each Worker instance is bound to a context. This context could be, for example, a\n * unique Github repository, or a directory in a file system, a specific customer service\n * in a set, etc. It is also generic, and can therefore be of any type.\n * When WorkerEvents are added to an empty queue, they are processed for being worked on\n * in the next tick of event loop.\n */\nexport class Worker<T> {\n    /** Holds the context for the Worker. */\n    private _context: T;\n    /** Holds the queue of events to work on. */\n    private queue: WorkerEvent[] = [];\n    /** Method to call when a Worker is to be removed. */\n    private onDone: WorkerRemove;\n\n    /**\n     * Creates the Worker class, specifying a context and the parent Map.\n     * @param context   The context to use for hashing.\n     * @param onDone    The method to use to remove a Worker post-event processing.\n     */\n    constructor(context: T, onDone: WorkerRemove) {\n        this._context = context;\n        this.onDone = onDone;\n    }\n\n    /**\n     * Retrieve the context for the Worker.\n     * @return The context for the Worker.\n     */\n    get context(): T {\n        return this._context;\n    }\n\n    /**\n     * Add a new event to the Worker's event queue.\n     * @param worker    The event to add to the queue.\n     */\n    public addEvent(event: WorkerEvent): void {\n        this.queue.push(event);\n        // If this is a new worker, ensure it operates.\n        if (this.queue.length === 1) {\n            this.runWorker();\n        }\n    }\n\n    /**\n     * Runs the next worker in the queue, before deleting its entry. Should more entries\n     * exist it then runs those.\n     */\n    private runWorker(): void {\n        // Get the next thing from the queue.\n        const entry = <WorkerEvent>this.queue[0];\n\n        // Run worker, proceed to next worker.\n        entry.workerMethod(entry.data)\n        .then(() => {\n            this.queue.shift();\n            if (this.queue.length > 0) {\n                this.runWorker();\n            } else {\n                // Unlink ourselves from our parent list.\n                this.onDone(this.context);\n            }\n        });\n    }\n}\n"],"sourceRoot":"../../lib"}