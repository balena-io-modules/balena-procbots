{"version":3,"sources":["utils/environment.ts"],"names":[],"mappings":";;AAgBA,oCAAoC;AACpC,iDAAsC;AA8BtC,sBAA6B,OAAe,EAAE,IAAe,EAAE,OAAwB;IACtF,IAAI,YAAwC,CAAC;IAC7C,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;QACb,YAAY,GAAG;YACd,GAAG,EAAE,OAAO,CAAC,GAAG;YAChB,OAAO,EAAE,OAAO,CAAC,OAAO;SACxB,CAAC;IACH,CAAC;IACD,MAAM,CAAC;QACN,OAAO;QACP,IAAI,EAAE,IAAI,IAAI,EAAE;QAChB,OAAO,EAAE,YAAY;KACrB,CAAC;AACH,CAAC;AAbD,oCAaC;AAAA,CAAC;AAeF,wBAA+B,OAAgB;IAC9C,IAAI,KAAK,GAAG,CAAC,CAAC,OAAO,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC,OAAO,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC;IACvD,MAAM,WAAW,GAAG;QACnB,MAAM,CAAC,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM;YAClC,MAAM,KAAK,GAAG,qBAAK,CAAC,OAAO,CAAC,OAAO,EAAE,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,OAAO,CAAC,CAAC;YACpE,IAAI,MAAc,CAAC;YACnB,IAAI,MAAc,CAAC;YAEnB,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI;gBAC5B,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;oBACb,MAAM,GAAG,EAAE,CAAC;gBACb,CAAC;gBACD,MAAM,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAC3B,CAAC,CAAC,CAAC;YACH,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,EAAE,CAAC,IAAI;gBAC5B,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;oBACb,MAAM,GAAG,EAAE,CAAC;gBACb,CAAC;gBACD,MAAM,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAC3B,CAAC,CAAC,CAAC;YAEH,KAAK,CAAC,WAAW,CAAC,OAAO,EAAE,MAAM,OAAO,CAAC,MAAM,GAAG,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC;YACpE,KAAK,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC,GAAU,KAAK,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;QACzD,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,GAAU;YAEnB,KAAK,EAAE,CAAC;YACR,EAAE,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC;gBACf,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;YAC9C,CAAC;YAED,MAAM,GAAG,CAAC;QACX,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC;IAGF,MAAM,CAAC,WAAW,EAAE,CAAC;AACtB,CAAC;AApCD,wCAoCC;AAAA,CAAC","file":"environment.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport { spawn } from 'child_process';\n\nexport interface CommandOptions {\n\t/** The CWD to run the command in. */\n\tcwd?: string;\n\t/**\n\t * How many retry attempts should occur if the command fails. Any value less than\n\t * one will result in no retries.\n\t */\n\tretries?: number;\n}\n\n/** Used to create external command to run on the environment hosting VersionBot. */\nexport interface Command {\n\t/** The command to run. */\n\tcommand: string;\n\t/** The arguments to pass to the command as an array. */\n\targs: string[];\n\t/** Any relevant options for the command. */\n\toptions?: CommandOptions;\n}\n\n/**\n * Build a new environment command object.\n *\n * @param command  The name of the command to execute.\n * @param args     An array of arguments to pass to the command.\n * @param options  A CommandOptions structure containing options required when the command is executed.\n * @returns        A Command object which can be passed to the RunCommand method.\n */\nexport function BuildCommand(command: string, args?: string[], options?: CommandOptions): Command {\n\tlet builtOptions: CommandOptions | undefined;\n\tif (options) {\n\t\tbuiltOptions = {\n\t\t\tcwd: options.cwd,\n\t\t\tretries: options.retries\n\t\t};\n\t}\n\treturn {\n\t\tcommand,\n\t\targs: args || [],\n\t\toptions: builtOptions\n\t};\n};\n\n/**\n * Executes an environment command.\n * The command will be executed via the `child_process.spawn` command. This ensures that\n * a new process is used to run the command, thus ensuring no access to the local shell.\n * The command will be attempted based on the value of the `options.retry` property in the\n * passed Command object. Should no retries be specified, command execution will only\n * be attempted once.\n *\n * @param params  A Command object detailing the command to execute.\n * @returns       A Promise containing a string from `stdout`. If output from `stderr` occurred, this will be used\n *                instead.\n * @throws        An error containing a message from the failed command's `stderr` output.\n */\nexport function ExecuteCommand(command: Command): Promise<{}> {\n\tlet tries = ((command.options || {}).retries || 0) + 1;\n\tconst callCommand = (): Promise<{}> => {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst child = spawn(command.command, command.args, command.options);\n\t\t\tlet stdout: string;\n\t\t\tlet stderr: string;\n\n\t\t\tchild.stdout.on('data', (data) => {\n\t\t\t\tif (!stdout) {\n\t\t\t\t\tstdout = '';\n\t\t\t\t}\n\t\t\t\tstdout += data.toString();\n\t\t\t});\n\t\t\tchild.stderr.on('data', (data) => {\n\t\t\t\tif (!stderr) {\n\t\t\t\t\tstderr = '';\n\t\t\t\t}\n\t\t\t\tstderr += data.toString();\n\t\t\t});\n\t\t\t// If there's any stderr output, we send that instead of stdout.\n\t\t\tchild.addListener('close', () => resolve(stderr ? stderr : stdout));\n\t\t\tchild.addListener('error', (err: Error) => reject(err));\n\t\t}).catch((err: Error) => {\n\t\t\t// Keep trying until we exhaust retries.\n\t\t\ttries--;\n\t\t\tif (tries > 0) {\n\t\t\t\treturn Promise.delay(1000).then(callCommand);\n\t\t\t}\n\n\t\t\tthrow err;\n\t\t});\n\t};\n\n\t// Attempt to carry out a number of retries until success or retry exhaustion.\n\treturn callCommand();\n};\n"],"sourceRoot":"../../lib"}