{"version":3,"sources":["services/front.ts"],"names":[],"mappings":";;AAgBA,oCAAoC;AACpC,yCAAgD;AAChD,4BAA4B;AAC5B,6BAA6B;AAC7B,4CAAqD;AAMrD;IAQI,YAAY,QAAiC;QANrC,iBAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACvD,kBAAa,GAA0B,EAAE,CAAC;QAE1C,WAAM,GAAG,IAAI,eAAM,EAAE,CAAC;QAkDpB,qBAAgB,GAAG,CAAC,KAAmB;YAC7C,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YACnB,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,YAAY;gBAEhD,EAAE,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,YAAY,CAAC,MAAM,EAAE,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;oBAC1D,MAAM,CAAC,YAAY,CAAC,cAAc,CAAC,YAAY,EAAE,KAAK,CAAC;yBACtD,KAAK,CAAC,CAAC,GAAU;wBAEd,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,mBAAU,CAAC,KAAK,EAAE,+CAA+C;4BAC/E,GAAG,CAAC,OAAO,CAAC,CAAC;oBACrB,CAAC,CAAC,CAAC;gBACP,CAAC;YACL,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC;QAChB,CAAC,CAAA;QA1DG,MAAM,kBAAkB,GAA4B,QAAQ,CAAC;QAC7D,IAAI,CAAC,MAAM,GAAG,kBAAkB,CAAC,MAAM,CAAC;QAGxC,IAAI,CAAC,QAAQ,GAAG,IAAI,iBAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IAC3C,CAAC;IAGM,QAAQ,CAAC,IAAwB;QAEpC,MAAM,WAAW,GAAuB,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,IAAI,EAAE,GAAG;YACtE,MAAM,CAAC,GAAG,KAAK,IAAI,CAAC,YAAY,CAAC;QACrC,CAAC,CAAC,CAAC;QACH,MAAM,eAAe,GAA4B,WAAW,CAAC,KAAK,CAAC;QAEnE,MAAM,CAAC,eAAe,CAAC,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,MAAoB;YAC1E,MAAM,CAAC;gBACH,QAAQ,EAAE,MAAM;gBAChB,MAAM,EAAE,IAAI,CAAC,YAAY;aAC5B,CAAC;QACN,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,GAAU;YAChB,MAAM,CAAC;gBACH,GAAG;gBACH,MAAM,EAAE,IAAI,CAAC,YAAY;aAC5B,CAAC;QACN,CAAC,CAAC,CAAC;IACP,CAAC;IAMD,IAAI,SAAS;QACT,MAAM,CAAC;YACH,KAAK,EAAE,IAAI,CAAC,QAAQ;SACvB,CAAC;IACN,CAAC;IAGD,IAAI,WAAW;QACX,MAAM,CAAC,IAAI,CAAC,YAAY,CAAC;IAC7B,CAAC;CAkBJ;AArED,oCAqEC;AAGD,8BAAqC,QAAiC;IAClE,MAAM,CAAC,IAAI,YAAY,CAAC,QAAQ,CAAC,CAAC;AACtC,CAAC;AAFD,oDAEC","file":"front.js","sourcesContent":["/*\nCopyright 2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport { Front, ResponseData } from 'front-sdk';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport { AlertLevel, Logger } from '../utils/logger';\nimport { FrontEmitRequestContext, FrontEmitterConstructor, FrontHandle } from './front-types';\nimport { ServiceEmitContext, ServiceEmitRequest, ServiceEmitResponse, ServiceEmitter, ServiceEvent,\n    ServiceRegistration } from './service-types';\n\n// The Flowdock service currently allows a client to send data to an Inbox.\nexport class FrontService implements ServiceEmitter {\n    private frontSDK: Front;\n    private _serviceName = path.basename(__filename.split('.')[0]);\n    private eventTriggers: ServiceRegistration[] = [];\n    private apiKey: string;\n    private logger = new Logger();\n\n    // The constructor is passed a specific data type.\n    constructor(constObj: FrontEmitterConstructor) {\n        // Only the listener deals with events.\n        const emitterConstructor = <FrontEmitterConstructor>constObj;\n        this.apiKey = emitterConstructor.apiKey;\n\n        // Create new Front SDK object.\n        this.frontSDK = new Front(this.apiKey);\n    }\n\n    // Send data to Front.\n    public sendData(data: ServiceEmitRequest): Promise<ServiceEmitResponse> {\n        // Get the Front context.\n        const emitContext: ServiceEmitContext = _.pickBy(data.contexts, (_val, key) => {\n            return key === this._serviceName;\n        });\n        const flowdockContext: FrontEmitRequestContext = emitContext.front;\n\n        return flowdockContext.method(flowdockContext.data).then((result: ResponseData) => {\n            return {\n                response: result,\n                source: this._serviceName\n            };\n        }).catch((err: Error) => {\n            return {\n                err,\n                source: this._serviceName\n            };\n        });\n    }\n\n    /**\n     * Retrieve the Front SDK API handle.\n     * @return  Front SDK handle.\n     */\n    get apiHandle(): FrontHandle {\n        return {\n            front: this.frontSDK\n        };\n    }\n\n    // Get the name of this service.\n    get serviceName(): string {\n        return this._serviceName;\n    }\n\n    // Handles all Front events to trigger actions, should the parameters meet those\n    // registered.\n    protected handleFrontEvent = (event: ServiceEvent): Promise<void> => {\n        console.log(event);\n        return Promise.map(this.eventTriggers, (registration) => {\n            // Is the event one of the type that triggers the action?\n            if (_.includes(registration.events, event.cookedEvent.type)) {\n                return registration.listenerMethod(registration, event)\n                .catch((err: Error) => {\n                    // We log the error, so that it's saved and matches up with any Alert.\n                    this.logger.alert(AlertLevel.ERROR, 'Error thrown in main event/label filter loop:' +\n                        err.message);\n                });\n            }\n        }).return();\n    }\n}\n\n// Create a new Front service Emitter.\nexport function createServiceEmitter(constObj: FrontEmitterConstructor): ServiceEmitter {\n    return new FrontService(constObj);\n}\n"],"sourceRoot":"../../lib"}