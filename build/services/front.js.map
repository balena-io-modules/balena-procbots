{"version":3,"sources":["services/front.ts"],"names":[],"mappings":"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","file":"front.js","sourcesContent":["/*\n Copyright 2016-2017 Resin.io\n\n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n\n http://www.apache.org/licenses/LICENSE-2.0\n\n Unless required by applicable law or agreed to in writing, software\n distributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\n limitations under the License.\n */\n\nimport * as Promise from 'bluebird';\nimport { Conversation, Front } from 'front-sdk';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport * as request from 'request-promise';\nimport { FrontConstructor, FrontEmitContext, FrontHandle } from './front-types';\nimport { Messenger } from './messenger';\nimport { MessengerAction, MessengerEmitResponse, ReceiptContext, TransmitContext } from './messenger-types';\nimport { ServiceEmitter, ServiceEvent, ServiceListener } from './service-types';\n\nexport class FrontService extends Messenger implements ServiceListener, ServiceEmitter {\n\tprivate static _serviceName = path.basename(__filename.split('.')[0]);\n\tprivate session: Front;\n\tprivate data: FrontConstructor;\n\n\tpublic constructor(data: FrontConstructor, listen = true) {\n\t\tsuper(listen);\n\t\tthis.data = data;\n\t\tthis.session = new Front(data.token);\n\t}\n\n\t/**\n\t * Promise to find the comment history of a particular thread.\n\t * @param thread  id of the thread to search.\n\t * @param _room   id of the room in which the thread resides.\n\t * @param filter  Criteria to match.\n\t */\n\tpublic fetchNotes = (thread: string, _room: string, filter: RegExp): Promise<string[]> => {\n\t\treturn this.session.conversation.listComments({conversation_id: thread})\n\t\t.then((comments) => {\n\t\t\treturn _.filter(comments._results, (value) => {\n\t\t\t\treturn filter.test(value.body);\n\t\t\t}).map((value) => {\n\t\t\t\treturn value.body;\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Promise to turn the data enqueued into a generic message format.\n\t * @param data  Raw data from the enqueue, remembering this is as dumb and quick as possible.\n\t * @returns     A promise that resolves to the generic form of the event.\n\t */\n\tpublic makeGeneric = (data: ServiceEvent): Promise<ReceiptContext> => {\n\t\t// Calculate common request details once\n\t\tconst getGeneric = {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${this.data.token}`\n\t\t\t},\n\t\t\tjson: true,\n\t\t\tmethod: 'GET',\n\t\t\turi: '', // Will be over-written\n\t\t};\n\t\t// Make specific forms of the request object for further details\n\t\tconst getEvent = _.cloneDeep(getGeneric);\n\t\tgetEvent.uri = `https://api2.frontapp.com/events/${data.rawEvent.id}`;\n\t\tconst getInboxes = _.cloneDeep(getGeneric);\n\t\tgetInboxes.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/inboxes`;\n\t\tconst getMessages = _.cloneDeep(getGeneric);\n\t\tgetMessages.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/messages`;\n\t\tconst getComments = _.cloneDeep(getGeneric);\n\t\tgetComments.uri = `https://api2.frontapp.com/conversations/${data.rawEvent.conversation.id}/comments`;\n\t\t// Gather further details of the enqueued event\n\t\treturn Promise.props({\n\t\t\tcomments: request(getComments),\n\t\t\tevent: request(getEvent),\n\t\t\tinboxes: request(getInboxes),\n\t\t\tmessages: request(getMessages),\n\t\t})\n\t\t.then((details: {comments: any, event: any, inboxes: any, messages: any}) => {\n\t\t\t// Pre-calculate a couple of values, to save line width\n\t\t\tconst message = details.event.target.data;\n\t\t\tconst first = details.comments._results.length + details.messages._results.length === 1;\n\t\t\tconst metadataFormat = details.event.type === 'comment' ? 'human' : 'img';\n\t\t\tconst metadata = Messenger.extractMetadata(message.body, metadataFormat);\n\t\t\tconst tags = _.map(details.event.conversation.tags, (tag: {name: string}) => {\n\t\t\t\treturn tag.name;\n\t\t\t});\n\t\t\t// Attempt to find the author of a message from the various places front might store it\n\t\t\tlet author = 'Unknown';\n\t\t\tif (message.author) {\n\t\t\t\tauthor = message.author.username;\n\t\t\t} else {\n\t\t\t\tfor (const recipient of message.recipients) {\n\t\t\t\t\tif (recipient.role === 'from') {\n\t\t\t\t\t\tauthor = recipient.handle;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Return the generic form of this event\n\t\t\treturn {\n\t\t\t\taction: MessengerAction.Create,\n\t\t\t\tfirst,\n\t\t\t\tgenesis: metadata.genesis || data.source || FrontService._serviceName,\n\t\t\t\thidden: first ? metadata.hidden : details.event.type === 'comment',\n\t\t\t\tsource: FrontService._serviceName,\n\t\t\t\tsourceIds: {\n\t\t\t\t\tflow: details.inboxes._results[0].id,\n\t\t\t\t\tmessage: message.id,\n\t\t\t\t\tthread: details.event.conversation.id,\n\t\t\t\t\turl: `https://app.frontapp.com/open/${details.event.conversation.id}`,\n\t\t\t\t\tuser: author,\n\t\t\t\t},\n\t\t\t\ttags,\n\t\t\t\ttext: message.text || metadata.content,\n\t\t\t\ttitle: details.event.conversation.subject,\n\t\t\t};\n\t\t});\n\t}\n\n\t/**\n\t * Promise to turn the generic message format into a specific form to be emitted.\n\t * @param data  Generic message format object to be encoded.\n\t * @returns     Promise that resolves to the emit suitable form.\n\t */\n\tpublic makeSpecific = (data: TransmitContext): Promise<FrontEmitContext> => {\n\t\t// Attempt to find the thread ID to know if this is a new conversation or not\n\t\tconst conversationId = data.toIds.thread;\n\t\tif (!conversationId) {\n\t\t\t// Find the title and user ID for the event\n\t\t\tconst subject = data.title;\n\t\t\tif (!subject) {\n\t\t\t\tthrow new Error('Cannot create Front Conversation without a title');\n\t\t\t}\n\t\t\treturn this.fetchUserId(data.toIds.user).then((userId) => {\n\t\t\t\t// The specific form that may be emitted\n\t\t\t\tconst footer = `${Messenger.stringifyMetadata(data, 'img')} ${Messenger.messageOfTheDay()}`;\n\t\t\t\treturn {\n\t\t\t\t\tendpoint: {\n\t\t\t\t\t\tmethod: this.apiHandle.front.message.send,\n\t\t\t\t\t},\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tauthor_id: userId,\n\t\t\t\t\t\tbody: `${data.text}<hr/>${footer}`,\n\t\t\t\t\t\t// Find the relevant channel for the inbox\n\t\t\t\t\t\tchannel_id: this.data.inbox_channels[data.toIds.flow],\n\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\tthread_ref: data.sourceIds.thread,\n\t\t\t\t\t\t},\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tarchive: false,\n\t\t\t\t\t\t\ttags: data.tags,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsender: {\n\t\t\t\t\t\t\thandle: data.toIds.user,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsubject,\n\t\t\t\t\t\tto: [data.sourceIds.user],\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\t\treturn Promise.props({\n\t\t\tconversation: this.session.conversation.get({conversation_id: conversationId}),\n\t\t\tuserId: this.fetchUserId(data.toIds.user)\n\t\t}).then((details: {conversation: Conversation, userId: string}) => {\n\t\t\tif (data.hidden) {\n\t\t\t\tconst footer = `${Messenger.stringifyMetadata(data, 'human')}`;\n\t\t\t\treturn {\n\t\t\t\t\tendpoint: {\n\t\t\t\t\t\tmethod: this.apiHandle.front.comment.create,\n\t\t\t\t\t},\n\t\t\t\t\tpayload: {\n\t\t\t\t\t\tauthor_id: details.userId,\n\t\t\t\t\t\tbody: `${data.text}${footer}`,\n\t\t\t\t\t\tconversation_id: conversationId,\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\tconst footer = `${Messenger.stringifyMetadata(data, 'img')} ${Messenger.messageOfTheDay()}`;\n\t\t\treturn {\n\t\t\t\tendpoint: {\n\t\t\t\t\tmethod: this.apiHandle.front.message.reply,\n\t\t\t\t},\n\t\t\t\tpayload: {\n\t\t\t\t\tauthor_id: details.userId,\n\t\t\t\t\tbody: `${data.text}<hr/>${footer}`,\n\t\t\t\t\tconversation_id: conversationId,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tarchive: false,\n\t\t\t\t\t},\n\t\t\t\t\tsubject: details.conversation.subject,\n\t\t\t\t\ttype: 'message',\n\t\t\t\t},\n\t\t\t};\n\t\t});\n\t}\n\n\t// This was created on an out-of-date understanding of how things should be structured.\n\t// TODO: It should be migrated as part of https://github.com/resin-io-modules/resin-procbots/issues/173\n\t/**\n\t * Promise to turn the generic message format into a tag update to be emitted.\n\t * @param data  Generic message format object to be encoded.\n\t * @returns     Promise that resolves to the tag update object.\n\t */\n\tpublic makeTagUpdate = (data: TransmitContext): Promise<FrontEmitContext> => {\n\t\tconst topicId = data.toIds.thread;\n\t\tif (!topicId) {\n\t\t\tthrow new Error('Cannot update tags without specifying thread');\n\t\t}\n\t\treturn Promise.resolve({\n\t\t\tendpoint: {\n\t\t\t\tmethod: this.apiHandle.front.conversation.update,\n\t\t\t},\n\t\t\tpayload: {\n\t\t\t\tconversation_id: topicId,\n\t\t\t\ttags: data.tags ? data.tags : [],\n\t\t\t},\n\t\t});\n\t}\n\n\t/**\n\t * Turns the generic, messenger, name for an event into a specific trigger name for this class.\n\t * @param eventType  Name of the event to translate, eg 'message'.\n\t * @returns          This class's equivalent, eg 'post'.\n\t */\n\tpublic translateEventName(eventType: string): string {\n\t\tconst equivalents: {[key: string]: string} = {\n\t\t\tmessage: 'event',\n\t\t};\n\t\treturn equivalents[eventType];\n\t}\n\n\t/**\n\t * Activate this service as a listener.\n\t */\n\tprotected activateMessageListener = (): void => {\n\t\t// This swallows response attempts to the channel, since we notice them on the inbox instead\n\t\tMessenger.expressApp.post('/front-dev-null', (_formData, response) => {\n\t\t\tresponse.sendStatus(200);\n\t\t});\n\t\t// Create an endpoint for this listener and enqueue events\n\t\tMessenger.expressApp.post(`/${FrontService._serviceName}/`, (formData, response) => {\n\t\t\tthis.queueEvent({\n\t\t\t\tdata: {\n\t\t\t\t\tcookedEvent: {\n\t\t\t\t\t\tcontext: formData.body.conversation.id,\n\t\t\t\t\t\ttype: 'event',\n\t\t\t\t\t},\n\t\t\t\t\trawEvent: formData.body,\n\t\t\t\t\tsource: FrontService._serviceName,\n\t\t\t\t},\n\t\t\t\tworkerMethod: this.handleEvent,\n\t\t\t});\n\t\t\tresponse.sendStatus(200);\n\t\t});\n\t}\n\n\t/**\n\t * Deliver the payload to the service. Sourcing the relevant context has already been performed.\n\t * @param data  The object to be delivered to the service.\n\t * @returns     Response from the service endpoint.\n\t */\n\tprotected sendPayload = (data: FrontEmitContext): Promise<MessengerEmitResponse> => {\n\t\treturn data.endpoint.method(data.payload).then(() => {\n\t\t\tif (data.payload.conversation_id) {\n\t\t\t\treturn Promise.resolve({\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\tmessage: `${data.payload.author_id}:${new Date().getTime()}`,\n\t\t\t\t\t\tthread: data.payload.conversation_id,\n\t\t\t\t\t\turl: `https://app.frontapp.com/open/${data.payload.conversation_id}`,\n\t\t\t\t\t},\n\t\t\t\t\tsource: FrontService._serviceName,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn this.findConversation(data.payload.subject)\n\t\t\t.then((conversationId) => {\n\t\t\t\treturn {\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\tmessage: `${data.payload.author_id}:${new Date().getTime()}`,\n\t\t\t\t\t\tthread: conversationId,\n\t\t\t\t\t\turl: `https://app.frontapp.com/open/${conversationId}`,\n\t\t\t\t\t},\n\t\t\t\t\tsource: FrontService._serviceName,\n\t\t\t\t};\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Find the ID of a user specified by username.\n\t * @param username  Target username to search for.\n\t * @returns         Promise that resolves to the user id.\n\t */\n\tprivate fetchUserId = (username: string): Promise<string|undefined> => {\n\t\t// Request a list of all teammates\n\t\tconst getTeammates = {\n\t\t\theaders: {\n\t\t\t\tauthorization: `Bearer ${this.data.token}`\n\t\t\t},\n\t\t\tjson: true,\n\t\t\tmethod: 'GET',\n\t\t\turi: 'https://api2.frontapp.com/teammates',\n\t\t};\n\t\treturn request(getTeammates).then((teammates: {_results: Array<{username: string, id: string}>}) => {\n\t\t\t// Resolve to the ID of the first matching teammate\n\t\t\tconst teammate = _.find(teammates._results, (eachTeammate) => {\n\t\t\t\treturn eachTeammate.username === username;\n\t\t\t});\n\t\t\tif (teammate) {\n\t\t\t\treturn teammate.id;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Attempt to find a recent conversation ID from it's subject line.\n\t * Done by subject because the conversation_reference provided is sometimes junk.\n\t * @param subject       Target subject line to search for.\n\t * @param attemptsLeft  Since conversations take time to propagate this method may recurse.\n\t * @returns             Promise that resolves to the ID of the conversation.\n\t */\n\tprivate findConversation = (subject: string, attemptsLeft: number = 10): Promise<string> => {\n\t\t// Find all the recent conversations\n\t\treturn this.session.conversation.list().then((response) => {\n\t\t\t// Filter these down to matching conversations\n\t\t\tconst conversationsMatched = _.filter(response._results, (conversation) => {\n\t\t\t\treturn conversation.subject === subject;\n\t\t\t});\n\t\t\t// Return the most recent, if any\n\t\t\tif (conversationsMatched.length > 0) {\n\t\t\t\treturn conversationsMatched[0].id;\n\t\t\t}\n\t\t\t// Recurse up to the specified number of times\n\t\t\tif (attemptsLeft > 1) {\n\t\t\t\treturn this.findConversation(subject, attemptsLeft - 1);\n\t\t\t}\n\t\t\tthrow new Error('Could not find relevant conversation.');\n\t\t});\n\t}\n\n\t/**\n\t * The name of this service, as required by the framework.\n\t * @returns  'flowdock' string.\n\t */\n\tget serviceName(): string {\n\t\treturn FrontService._serviceName;\n\t}\n\n\t/**\n\t * Retrieve the SDK API handle for Front.\n\t * @return  The Front SDK API handle.\n\t */\n\tget apiHandle(): FrontHandle {\n\t\treturn {\n\t\t\tfront: this.session\n\t\t};\n\t}\n}\n\n/**\n * Build this class, typed and activated as a listener.\n * @returns  Service Listener object, awakened and ready to go.\n */\nexport function createServiceListener(data: FrontConstructor): ServiceListener {\n\treturn new FrontService(data, true);\n}\n\n/**\n * Build this class, typed as an emitter.\n * @returns  Service Emitter object, ready for your events.\n */\nexport function createServiceEmitter(data: FrontConstructor): ServiceEmitter {\n\treturn new FrontService(data, false);\n}\n\n/**\n * Build this class, typed as a message service.\n * @returns  Message Service object, ready to convert events.\n */\nexport function createMessageService(data: FrontConstructor): Messenger {\n\treturn new FrontService(data, false);\n}\n"],"sourceRoot":"../../lib"}