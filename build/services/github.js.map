{"version":3,"sources":["services/github.ts"],"names":[],"mappings":"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","file":"github.js","sourcesContent":["/*\nCopyright 2016-2017 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Promise from 'bluebird';\nimport * as bodyParser from 'body-parser';\nimport * as crypto from 'crypto';\nimport * as express from 'express';\nimport * as GithubApi from 'github';\nimport * as jwt from 'jsonwebtoken';\nimport * as _ from 'lodash';\nimport * as path from 'path';\nimport * as request from 'request-promise';\nimport * as GithubApiTypes from '../apis/githubapi-types';\nimport { Worker, WorkerEvent } from '../framework/worker';\nimport { WorkerClient } from '../framework/worker-client';\nimport { AlertLevel, Logger, LogLevel } from '../utils/logger';\nimport { GithubConstructor, GithubEmitRequestContext, GithubHandle, GithubIntegration,\n    GithubListenerConstructor, GithubRegistration } from './github-types';\nimport { ServiceEmitContext, ServiceEmitRequest, ServiceEmitResponse, ServiceEmitter,\n    ServiceEvent, ServiceListener } from './service-types';\n\n/** Github label interface. */\ninterface LabelDetails {\n    /** The PR or issue number. */\n    number: string;\n    /** Repository information. */\n    repo: {\n        /** Owner of the repository. */\n        owner: {\n            login: string;\n        };\n        /** Name of the repository. */\n        name: string;\n    };\n}\n\n/**\n * The Github service allows all interaction with Github.\n * It implements both a ServiceListener that listens to webhooks and a ServiceEmitter\n * that communicates with GH via its API.\n */\nexport class GithubService extends WorkerClient<string> implements ServiceListener, ServiceEmitter {\n    protected getWorker: (event: WorkerEvent) => Worker<string>;\n    protected authToken: string;\n    protected pem: string;\n    protected githubApi: any;\n    private integrationId: number;\n    private eventTriggers: GithubRegistration[] = [];\n    // This is the current voodoo to allow all API calls to succeed.\n    // Accept: 'application/vnd.github.black-cat-preview+json' is now out of date\n    private ghApiAccept = 'application/vnd.github.loki-preview+json';\n    private _serviceName = path.basename(__filename.split('.')[0]);\n    private logger = new Logger();\n\n    /**\n     * Constructor for both the ServiceListener and ServiceEmitter.\n     * @param constObj  Construction object for either ServiceListener or ServiceEmitter.\n     */\n    constructor(constObj: GithubListenerConstructor | GithubConstructor) {\n        super();\n\n        // Determine type of service.\n        if (constObj.loginType.type !== 'integration') {\n            throw new Error('Do not yet support non-Integration type clients');\n        }\n        constObj.loginType = <GithubIntegration>constObj.loginType;\n\n        // Set the Integration ID.\n        this.integrationId = constObj.loginType.integrationId;\n        this.pem = constObj.loginType.pem;\n\n        // The `github` module is a bit behind the preview API. We may have to override\n        // some of the methods here (PR review comments for a start).\n        // Both the listener and the emitter need access to the API.\n        this.githubApi = new GithubApi({\n            Promise: <any>Promise,\n            headers: {\n                Accept: this.ghApiAccept\n            },\n            host: 'api.github.com',\n            protocol: 'https',\n            timeout: 5000\n        });\n        this.authenticate();\n\n        // Only the listener deals with events.\n        if (constObj.type === 'listener') {\n            const listenerConstructor = <GithubListenerConstructor>constObj;\n\n            // The getWorker method is an overload for generic context types.\n            // In the case of the GithubBot, it's the name of the repo (a string).\n            this.getWorker = (event: WorkerEvent): Worker<string> => {\n                const repository = event.data.rawEvent.repository;\n                let context = '';\n\n                // If there's a repository, we use the full name as the context,\n                // else we use a generic. Generic contexts can occur on events that\n                // are not linked to a repo (adding/removing repo from Integration,\n                // creating a user, deleting a user, etc.)\n                if (repository) {\n                    context = repository.full_name;\n                } else {\n                    context = 'generic';\n                }\n                let worker: Worker<string> | undefined = this.workers.get(context);\n\n                // If we already have a worker for this context (the repo name), return it.\n                if (worker) {\n                    return worker;\n                }\n\n                // Create new Worker using the repo name as context.\n                // We currently just use Procbot's removal method.\n                worker = new Worker(context, this.removeWorker);\n\n                // Note that workers are self-regualting; that is, they will remove themselves\n                // from the Map once there are no more queued tasks.\n                this.workers.set(context, worker);\n\n                return worker;\n            };\n\n            // Verify that events being sent our way are valid and authenticated.\n            function verifyWebhookToken(payload: string, hubSignature: string): boolean {\n                const newHmac: any = crypto.createHmac('sha1', listenerConstructor.webhookSecret);\n                newHmac.update(payload);\n                if (('sha1=' + newHmac.digest('hex')) === hubSignature) {\n                    return true;\n                }\n\n                return false;\n            }\n\n            // Standard Express installation.\n            const app = express();\n            app.use(bodyParser.urlencoded({ extended: true }));\n            app.use(bodyParser.json());\n\n            // Listen for Webhooks on the path specified by the client.\n            app.post(listenerConstructor.path, (req, res) => {\n                const eventType: string = req.get('x-github-event');\n                const payload = req.body;\n\n                // Ensure that the sender is authorised and uses our secret.\n                if (!verifyWebhookToken(JSON.stringify(payload), req.get('x-hub-signature'))) {\n                    res.sendStatus(401);\n                    return;\n                }\n\n                // Let the hook get on with it.\n                res.sendStatus(200);\n\n                // Add this event into our queue.\n                this.queueEvent({\n                    data: {\n                        cookedEvent: {\n                            data: payload,\n                            githubAuthToken: this.authToken,\n                            type: eventType\n                        },\n                        rawEvent: payload,\n                        source: this._serviceName\n                    },\n                    workerMethod: this.handleGithubEvent\n                });\n            });\n\n            // Listen on the specified port.\n            app.listen(listenerConstructor.port, () => {\n                this.logger.log(LogLevel.INFO, `---> ${listenerConstructor.client}: Listening Github Service on ` +\n                    `':${listenerConstructor.port}${listenerConstructor.path}'`);\n            });\n        }\n    }\n\n    /**\n     * Create a new event triggered action for the list.\n     * @param registration  A GithubRegistration object detailing the events required by the client.\n     */\n    public registerEvent(registration: GithubRegistration): void {\n        this.eventTriggers.push(registration);\n    }\n\n    /**\n     * Send data to Github.\n     * This method will automatically deal with paged requests. Should any passed data\n     * reference the `per_page` or `page` properties, these will be honoured, else page\n     * fetches will start at 0 with the default 30 entries per page\n     * Fetches will occur until there are no pages left to fetch.\n     * @param data  A ServiceEmitRequest detailling the call to make and associated data.\n     * @return      A ServiceEmitResponse comprised from the response from Github.\n     */\n    public sendData(data: ServiceEmitRequest): Promise<ServiceEmitResponse> {\n        // Try and find the context for the Github request.\n        const emitContext: ServiceEmitContext = _.pickBy(data.contexts, (_val, key) => {\n            return key === this._serviceName;\n        });\n        const githubContext: GithubEmitRequestContext = _.cloneDeep(emitContext.github);\n        let retriesLeft = 3;\n        let returnArray: any = [];\n        let perPage = githubContext.data['per_page'] || 30;\n        let page = githubContext.data.page || 1;\n\n        // We need a new Promise here, as we might need to do retries.\n        const runApi = (): Promise<ServiceEmitResponse> => {\n            retriesLeft -= 1;\n\n            // Run the method.\n            return githubContext.method(githubContext.data).then((resData: any) => {\n                let response = resData;\n\n                // If the returned data is an array, check the number of results.\n                // If the same length as `per_page`, then ask for another one.\n                if (Array.isArray(resData)) {\n                    returnArray = _.concat(returnArray, resData);\n                    retriesLeft += 1;\n\n                    // If there weren't page details previously, we now need to apply them\n                    // to the next fetch.\n                    // Then increase page number.\n                    if (!githubContext.data.page) {\n                        githubContext.data.page = page;\n                    }\n                    if (!githubContext.data['per_page']) {\n                        githubContext.data['per_page'] = perPage;\n                    }\n                    githubContext.data.page++;\n\n                    // Check to see if the last set of results was less than `per_page`.\n                    // If not, get the next page.\n                    if (resData.length === perPage) {\n                        return runApi();\n                    }\n\n                    // Finally we filter for duplicates. We do this via URL.\n                    response = _.uniqBy(returnArray, 'url');\n                }\n\n                // Else if not an array (or less entries then `per_page` returned), just\n                // return the data.\n                return {\n                    response,\n                    source: this._serviceName\n                };\n            }).catch((err: Error) => {\n                // Sometimes the gateway can time out if we don't respond quickly enough.\n                // This will destroy the ability to continue for this callset, so we exit.\n                if (err.message.indexOf('504: Gateway Timeout') !== -1) {\n                    return {\n                        err: new Error('Github API timed out, could not complete'),\n                        source: this._serviceName\n                    };\n                } else {\n                    // Error message is actually JSON.\n                    let ghError: GithubApiTypes.GithubError | void;\n                    try {\n                        ghError = JSON.parse(err.message);\n                    } catch(_err) {\n                        this.logger.log(LogLevel.WARN, `Error thrown was not a Github Service error:\\n${err.message}`);\n                    }\n\n                    // If there are no more retries, or we couldn't find the required\n                    // details, reject.\n                    if ((retriesLeft < 1) || (ghError && (ghError.message === 'Not Found'))) {\n                        // No more retries, just reject.\n                        return {\n                            err,\n                            source: this._serviceName\n                        };\n                    } else {\n                        if (ghError && (ghError.message === 'Bad credentials')) {\n                            // Re-authenticate, then try again.\n                            return this.authenticate().then(runApi);\n                        } else {\n                            // If there's more retries, try again in 5 seconds.\n                            return Promise.delay(5000).then(runApi);\n                        }\n                    }\n                }\n            });\n        };\n\n        return runApi();\n    }\n\n    /**\n     * Get the name of the Github service.\n     * @return  The name of the service.\n     */\n    get serviceName(): string {\n        return this._serviceName;\n    }\n\n    /**\n     * Retrieve the Github SDK API handle.\n     * @return  Github SDK handle.\n     */\n    get apiHandle(): GithubHandle {\n        return {\n            github: this.githubApi\n        };\n    }\n\n    /**\n     * Handles all Github events to trigger actions, should the parameters meet those registered.\n     * @param event A ServiceEvent created from the event sent by Github.\n     * @return      Promise that is fulfilled once all processing of the event has completed.\n     */\n    protected handleGithubEvent = (event: ServiceEvent): Promise<void> => {\n        // Determine the head to use based on the event.\n        const labelHead = (): LabelDetails | void => {\n            // Note that a label event itself is not in itself a labelled type,\n            // so we don't check for it.\n            switch (event.cookedEvent.type) {\n                case 'issue_comment':\n                case 'issues':\n                    return {\n                        number: event.rawEvent.issue.number,\n                        repo: event.rawEvent.repository\n                    };\n\n                case 'pull_request':\n                case 'pull_request_review':\n                case 'pull_request_review_comment':\n                    return {\n                        number: event.rawEvent.pull_request.number,\n                        repo: event.rawEvent.repository\n                    };\n\n                default:\n                    return;\n            }\n        };\n\n        return Promise.map(this.eventTriggers, (registration) => {\n            // Is the event one of the type that triggers the action?\n            if (_.includes(registration.events, event.cookedEvent.type)) {\n                let labelEvent = labelHead();\n                let labelPromise = Promise.resolve({source: this._serviceName});\n\n                // Are there any labels (trigger or suppression) set on the action?\n                if ((registration.triggerLabels || registration.suppressionLabels) && labelEvent) {\n                    // OK, so we've got a label event, so we now have to get all the labels\n                    // for the appropriate issue.\n                    const request: ServiceEmitRequest = {\n                        contexts: {},\n                        source: this._serviceName\n                    };\n                    request.contexts[this._serviceName] = {\n                        data: {\n                            number: labelEvent.number,\n                            owner: labelEvent.repo.owner.login,\n                            repo: labelEvent.repo.name\n                        },\n                        method: this.githubApi.issues.getIssueLabels\n                    };\n                    labelPromise = this.sendData(request);\n                }\n                labelPromise.then((data: ServiceEmitResponse) => {\n                    // If there are some labels, then we process them.\n                    const labels = data.response;\n                    if (labels) {\n                        const foundLabels: string[] = labels.map((label: any) => {\n                            return label.name;\n                        });\n\n                        // First, are all the suppression labels present?\n                        if (registration.suppressionLabels &&\n                            (_.intersection(registration.suppressionLabels, foundLabels).length ===\n                            registration.suppressionLabels.length)) {\n                            this.logger.log(LogLevel.DEBUG,\n                                `Dropping '${registration.name}' as suppression labels are all present`);\n                            return;\n                        }\n                        // Secondly, are all the trigger labels present?\n                        if (registration.triggerLabels &&\n                            (_.intersection(registration.triggerLabels, foundLabels).length !==\n                            registration.triggerLabels.length)) {\n                            this.logger.log(LogLevel.DEBUG,\n                                `Dropping '${registration.name}' as not all trigger labels are present`);\n                            return;\n                        }\n                    }\n\n                    return registration.listenerMethod(registration, event);\n                }).catch((err: Error) => {\n                    // We log the error, so that it's saved and matches up with any Alert.\n                    this.logger.alert(AlertLevel.ERROR, 'Error thrown in main event/label filter loop:' +\n                        err.message);\n                });\n            }\n        }).return();\n    }\n\n    /**\n     * Authenticate against the Github API and Installation environment (for Integrations).\n     * @return  Promise fulfilled once authentication has occurred.\n     */\n    protected authenticate(): Promise<void> {\n        // Initialise JWTs\n        const privatePem = new Buffer(this.pem, 'base64').toString();\n        const payload = {\n            exp: Math.floor((Date.now() / 1000)) + (10 * 60),\n            iat: Math.floor((Date.now() / 1000)),\n            iss: this.integrationId\n        };\n        const jwToken = jwt.sign(payload, privatePem, { algorithm: 'RS256' });\n        const installationsOpts = {\n            headers: {\n                'Accept': 'application/vnd.github.machine-man-preview+json',\n                'Authorization': `Bearer ${jwToken}`,\n                'User-Agent': 'request'\n            },\n            json: true,\n            url: 'https://api.github.com/integration/installations'\n        };\n\n        return request.get(installationsOpts).then((installations) => {\n            // Get the URL for the token.\n            const tokenUrl = installations[0].access_tokens_url;\n\n            // Request new token.\n            const tokenOpts: any = {\n                headers: {\n                    'Accept': 'application/vnd.github.machine-man-preview+json',\n                    'Authorization': `Bearer ${jwToken}`,\n                    'User-Agent': 'request'\n                },\n                json: true,\n                method: 'POST',\n                url: tokenUrl\n            };\n\n            return request.post(tokenOpts);\n        }).then((tokenDetails) => {\n            // We also need to take into account the expiry date, which will require a new kickoff.\n            this.authToken = tokenDetails.token;\n            this.githubApi.authenticate({\n                token: this.authToken,\n                type: 'token'\n            });\n\n            // For debug.\n            this.logger.log(LogLevel.INFO, `token for manual fiddling is: ${tokenDetails.token}`);\n            this.logger.log(LogLevel.INFO, `token expires at: ${tokenDetails.expires_at}`);\n            this.logger.log(LogLevel.INFO, 'Base curl command:');\n            this.logger.log(LogLevel.INFO,\n                `curl -XGET -H \"Authorisation: token ${tokenDetails.token}\" ` +\n                `-H \"Accept: ${this.ghApiAccept}\" https://api.github.com/`);\n        });\n    }\n}\n\n/**\n * Create a new Github ServiceListener.\n * @param constObj  Constructor for the ServiceListener.\n * @return          A new instance of the ServiceListener.\n */\nexport function createServiceListener(constObj: GithubListenerConstructor): ServiceListener {\n    return new GithubService(constObj);\n}\n\n/**\n * Create a new Github ServiceEmitter.\n * @param constObj  Constructor for the ServiceEmitter.\n * @return          A new instance of the ServiceEmitter.\n */\nexport function createServiceEmitter(constObj: GithubConstructor): ServiceEmitter {\n    return new GithubService(constObj);\n}\n"],"sourceRoot":"../../lib"}