{"version":3,"sources":["services/messenger/datahubs/flowdock.ts"],"names":[],"mappings":"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","file":"flowdock.js","sourcesContent":["/*\n Copyright 2016-2017 Resin.io\n\n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n\n http://www.apache.org/licenses/LICENSE-2.0\n\n Unless required by applicable law or agreed to in writing, software\n distributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\n limitations under the License.\n */\n\nimport * as Promise from 'bluebird';\nimport { Session } from 'flowdock';\nimport * as _ from 'lodash';\nimport { FlowdockConstructor, FlowdockMessage } from '../../flowdock-types';\nimport { DataHub, DataHubError, DataHubErrorCode } from './datahub';\n\n/**\n * A service retrieves values from the flowdock 1-1 history\n */\nexport class FlowdockDataHub implements DataHub {\n\t/** SDK session that that is queried for 1-1 history. */\n\tprivate session: Session;\n\t/** Name of the organization to scope the requests. */\n\tprivate organization: string;\n\n\tconstructor(data: FlowdockConstructor) {\n\t\tthis.session = new Session(data.token);\n\t\t// The flowdock service both emits and calls back the error\n\t\t// We'll just ignore the emit to prevent it bubbling\n\t\t// This is not logged because a failure to find a value in this service could be deliberate\n\t\tthis.session.on('error', () => { /* do nothing */});\n\t\tthis.organization = data.organization;\n\t}\n\n\t/**\n\t * Search for the specified value set by a user.\n\t * @param user    Username to search associated with.\n\t * @param service The service for which we seek a value, eg discourse\n\t * @param key     Name of the value to retrieve.\n\t * @returns       Promise that resolves to the value.\n\t */\n\tpublic fetchValue(user: string, service: string, key: string): Promise<string> {\n\t\t// Retrieve a particular regex from the 1-1 message history of the user\n\t\tconst findKey = new RegExp(`My ${service} ${key} is (\\\\S+)`, 'i');\n\t\treturn this.fetchPrivateMessages(user, findKey)\n\t\t.then((valueArray) => {\n\t\t\tconst value = valueArray[valueArray.length - 1].match(findKey);\n\t\t\tif (value) {\n\t\t\t\treturn value[1];\n\t\t\t}\n\t\t\tthrow new DataHubError(DataHubErrorCode.ValueNotFound, `Could not find value $key for $user`);\n\t\t});\n\t}\n\n\t/**\n\t * Search for recent private messages with our account that match on username and regex.\n\t * @param username  Scope of the private messages to search.\n\t * @param filter    Narrow our search to just matches.\n\t * @returns         Promise that resolves to the message strings.\n\t */\n\tprivate fetchPrivateMessages(username: string, filter: RegExp): Promise<string[]> {\n\t\t// Fetch the id then 1-1 history associated with the username\n\t\treturn this.fetchUserId(username)\n\t\t.then((userId) => {\n\t\t\tconst match = filter.source.match(/^([\\w\\s]+)/i);\n\t\t\treturn this.fetchFromSession(`/private/${userId}/messages`, match ? match[1] : undefined)\n\t\t\t.then((fetchedMessages) => {\n\t\t\t\t// Prune and clean the message history to text of interest\n\t\t\t\treturn _.filter(fetchedMessages, (message: FlowdockMessage) => {\n\t\t\t\t\treturn filter.test(message.content);\n\t\t\t\t}).map((message: FlowdockMessage) => {\n\t\t\t\t\treturn message.content;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Fetch a user's id from their username.\n\t * @param username  Username to search for.\n\t * @returns         id of the user.\n\t */\n\tprivate fetchUserId = (username: string): Promise<string | undefined> => {\n\t\t// Get all the users of the service\n\t\treturn this.fetchFromSession(`/organizations/${this.organization}/users`)\n\t\t.then((foundUsers) => {\n\t\t\t// Generate an array of user objects with matching username\n\t\t\tconst matchingUsers = _.filter(foundUsers, (eachUser: any) => {\n\t\t\t\treturn eachUser.nick.toLowerCase() === username.toLowerCase();\n\t\t\t});\n\t\t\t// Return id if we've exactly one user for a particular username\n\t\t\tif (matchingUsers.length === 1) {\n\t\t\t\treturn matchingUsers[0].id;\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Utility function to structure the flowdock session as a promise a little.\n\t * @param path    Endpoint to retrieve.\n\t * @param search  Optional, some words which may be used to shortlist the results.\n\t * @returns       Response from the session.\n\t */\n\tprivate fetchFromSession = (path: string, search?: string): Promise<any> => {\n\t\treturn new Promise<any>((resolve, reject) => {\n\t\t\tthis.session.get(path, {search}, (error?: Error, result?: any) => {\n\t\t\t\tif (result) {\n\t\t\t\t\tresolve(result);\n\t\t\t\t} else {\n\t\t\t\t\treject(error);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n}\n\n/**\n * Builds a DataHub that searches 1-1 history for values.\n * @param data  Connection details that should be used to connect to flowdock.\n * @returns     A built DataHub, ready to seek out information from 1-1 flowdock history.\n */\nexport function createDataHub(data: FlowdockConstructor): DataHub {\n\treturn new FlowdockDataHub(data);\n}\n"],"sourceRoot":"../../../../lib"}