{"version":3,"sources":["services/messenger/translators/translator-scaffold.ts"],"names":[],"mappings":"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","file":"translator-scaffold.js","sourcesContent":["/*\n Copyright 2017 Resin.io\n\n Licensed under the Apache License, Version 2.0 (the \"License\");\n you may not use this file except in compliance with the License.\n You may obtain a copy of the License at\n\n http://www.apache.org/licenses/LICENSE-2.0\n\n Unless required by applicable law or agreed to in writing, software\n distributed under the License is distributed on an \"AS IS\" BASIS,\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n See the License for the specific language governing permissions and\n limitations under the License.\n */\n\nimport * as Promise from 'bluebird';\nimport * as _ from 'lodash';\nimport {\n\tBasicMessageInformation, EmitInstructions, MessengerConstructor, MessengerEvent,\n\tMessengerResponse, TransmitInformation,\n} from '../../messenger-types';\nimport { ServiceScaffoldEvent } from '../../service-scaffold-types';\nimport { Translator, TranslatorError } from './translator';\nimport {\n\tEmitConverters, EventEquivalencies, PublicityIndicator,\n\tResponseConverters, TranslatorErrorCode, TranslatorMetadata,\n} from './translator-types';\n\n/**\n * Class to help build a translator to convert between messenger standard forms\n * and service specific forms.\n */\nexport abstract class TranslatorScaffold implements Translator {\n\t/**\n\t * Encode the metadata of an event into a string to embed in the message.\n\t * @param data    Event to gather details from.\n\t * @param format  Optional, markdown or plaintext, defaults to markdown.\n\t * @returns       Text with data embedded.\n\t */\n\tprotected static stringifyMetadata(data: BasicMessageInformation, format: string): string {\n\t\tconst indicators = data.details.hidden ?\n\t\t\tTranslatorScaffold.getIndicatorArrays().hidden :\n\t\t\tTranslatorScaffold.getIndicatorArrays().shown;\n\t\tswitch (format) {\n\t\t\tcase 'human':\n\t\t\t\treturn `(${indicators.word} from ${data.source.service})`;\n\t\t\tcase 'emoji':\n\t\t\t\treturn `[${indicators.emoji}](${data.source.service})`;\n\t\t\tcase 'logo':\n\t\t\t\tconst baseUrl = process.env.MESSAGE_TRANSLATOR_IMG_BASE_URL;\n\t\t\t\tconst queryString = `?hidden=${indicators.word}&source=${data.source.service}`;\n\t\t\t\treturn `<img src=\"${baseUrl}${queryString}\" height=\"18\" \\/> ${TranslatorScaffold.messageOfTheDay()}`;\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`${format} format not recognised`);\n\t\t}\n\t}\n\n\t/**\n\t * Given a basic string this will extract a more rich context for the event, if embedded.\n\t * @param message  Basic string that may contain metadata.\n\t * @param format   Format of the metadata encoding.\n\t * @returns        Object of content, genesis and hidden.\n\t */\n\tprotected static extractMetadata(message: string, format: string): TranslatorMetadata {\n\t\tconst indicators = TranslatorScaffold.getIndicatorArrays();\n\t\tconst wordCapture = `(${indicators.hidden.word}|${indicators.shown.word})`;\n\t\tconst beginsLine = '(?:^|\\\\r|\\\\n)(?:\\\\s*)';\n\t\tconst endsLine = '(?:\\\\s*)(?:$|\\\\r|\\\\n)';\n\t\tswitch (format.toLowerCase()) {\n\t\t\tcase 'char':\n\t\t\t\tconst charCapture = `(${_.escapeRegExp(indicators.hidden.char)}|${_.escapeRegExp(indicators.shown.char)})`;\n\t\t\t\tconst charRegex = new RegExp(`${beginsLine}${charCapture}`);\n\t\t\t\treturn TranslatorScaffold.metadataByRegex(message, charRegex);\n\t\t\tcase 'human':\n\t\t\t\tconst parensRegex = new RegExp(`${beginsLine}\\\\(${wordCapture} from (\\\\w*)\\\\)${endsLine}`, 'i');\n\t\t\t\treturn TranslatorScaffold.metadataByRegex(message, parensRegex);\n\t\t\tcase 'emoji':\n\t\t\t\tconst emojiCapture = `(${indicators.hidden.emoji}|${indicators.shown.emoji})`;\n\t\t\t\tconst emojiRegex = new RegExp(`${beginsLine}\\\\[?${emojiCapture}\\\\]?\\\\(?(\\\\w*)\\\\)?`, 'i');\n\t\t\t\treturn TranslatorScaffold.metadataByRegex(message, emojiRegex);\n\t\t\tcase 'logo':\n\t\t\t\tconst baseUrl = _.escapeRegExp(process.env.MESSAGE_TRANSLATOR_IMG_BASE_URL);\n\t\t\t\tconst query = `\\\\?hidden=${wordCapture}&source=(\\\\w*)`;\n\t\t\t\tconst imgRegex = new RegExp(`<img src=\"${baseUrl}${query}\" height=\"18\" \\/>(?:.*)${endsLine}`, 'i');\n\t\t\t\treturn TranslatorScaffold.metadataByRegex(message, imgRegex);\n\t\t\tdefault:\n\t\t\t\tthrow new Error(`${format} format not recognised`);\n\t\t}\n\t}\n\n\t/**\n\t * Generic handler for stock metadata regex, must match the syntax of:\n\t * first match is the indicator of visibility, second match is message source, remove the whole match for content.\n\t * @param message String to evaluate into metadata.\n\t * @param regex   Criteria for extraction.\n\t * @returns       Object of the metadata, decoded.\n\t */\n\tprivate static metadataByRegex(message: string, regex: RegExp): TranslatorMetadata {\n\t\tconst indicators = TranslatorScaffold.getIndicatorArrays();\n\t\tconst metadata = message.match(regex);\n\t\tif (metadata) {\n\t\t\treturn {\n\t\t\t\tcontent: message.replace(regex, '').trim(),\n\t\t\t\tgenesis: metadata[2] || null,\n\t\t\t\thidden: !_.includes(_.values(indicators.shown), metadata[1]),\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\tcontent: message.trim(),\n\t\t\tgenesis: null,\n\t\t\thidden: true,\n\t\t};\n\t}\n\n\t/** Return a string, based on the day, from the configured MOTD array */\n\tprivate static messageOfTheDay(): string {\n\t\ttry {\n\t\t\tconst messages = JSON.parse(process.env.MESSAGE_TRANSLATOR_MESSAGES_OF_THE_DAY);\n\t\t\tconst daysSinceDatum = Math.floor(new Date().getTime() / 86400000);\n\t\t\treturn messages[daysSinceDatum % messages.length];\n\t\t} catch (error) {\n\t\t\tthrow new Error('MESSAGE_TRANSLATOR_MESSAGES_OF_THE_DAY not set correctly, motd not json.');\n\t\t}\n\t}\n\n\t/**\n\t * Retrieve from the environment array of strings to use as indicators of visibility.\n\t * @returns  Object of arrays of indicators, shown and hidden.\n\t */\n\tprivate static getIndicatorArrays(): { 'shown': PublicityIndicator, 'hidden': PublicityIndicator } {\n\t\tlet indicators;\n\t\ttry {\n\t\t\t// Retrieve publicity indicators from the environment\n\t\t\tindicators = JSON.parse(process.env.MESSAGE_TRANSLATOR_PRIVACY_INDICATORS);\n\t\t} catch (error) {\n\t\t\tthrow new Error('MESSAGE_TRANSLATOR_PRIVACY_INDICATORS not JSON.');\n\t\t}\n\t\tif (\n\t\t\tindicators.shown.emoji && indicators.shown.char && indicators.shown.word &&\n\t\t\tindicators.hidden.emoji && indicators.hidden.char && indicators.hidden.word\n\t\t) {\n\t\t\treturn indicators;\n\t\t}\n\t\tthrow new Error('MESSAGE_TRANSLATOR_PRIVACY_INDICATORS not set correctly.');\n\t}\n\n\t/**\n\t * A dictionary of messenger event names, eg post, into service specific events, eg inbound_message, outbound_message.\n\t */\n\tprotected abstract eventEquivalencies: EventEquivalencies;\n\n\t/**\n\t * Contains methods that may be invoked by the public messageIntoEmitDetails\n\t * method and will convert between service specific and communal (messenger) formats.\n\t */\n\tprotected abstract emitConverters: EmitConverters;\n\n\t/**\n\t * Contains methods that may be invoked by the public\n\t * responseIntoMessageResponse method and will convert\n\t * between specific and generic formats.\n\t */\n\tprotected abstract responseConverters: ResponseConverters;\n\n\t/**\n\t * Convert the provided message into details that may be passed to the emitter.\n\t * @param message  Message object, in generic form, to create a payload from.\n\t * @returns        Promise to provide the payload that may be passed straight to the emitter.\n\t */\n\tpublic messageIntoEmitDetails(message: TransmitInformation): Promise<EmitInstructions> {\n\t\t// This searches the abstract lookup object for a match on the action desired.\n\t\tconst converter = this.emitConverters[message.action];\n\t\tif (converter) {\n\t\t\treturn converter(message);\n\t\t}\n\t\t// Rejecting if the inherited child translator has registered no suitable method.\n\t\treturn Promise.reject(new TranslatorError(\n\t\t\tTranslatorErrorCode.EmitUnsupported,\n\t\t\t`${message.action} not translatable to ${message.target.service} yet.`,\n\t\t));\n\t}\n\n\t/**\n\t * Convert the response from the emitter into a generic form\n\t * @param message   The original message, only used in services where the response is incomplete\n\t * @param response  The response from the emitter to convert\n\t * @returns         A promise that resolves to the generic form of the response\n\t */\n\tpublic responseIntoMessageResponse(\n\t\tmessage: TransmitInformation, response: any\n\t): Promise<MessengerResponse> {\n\t\t// This searches the abstract lookup object for a match on the action desired.\n\t\tconst converter = this.responseConverters[message.action];\n\t\tif (converter) {\n\t\t\treturn converter(message, response);\n\t\t}\n\t\t// Rejecting if the inherited child translator has registered no suitable method.\n\t\treturn Promise.reject(new TranslatorError(\n\t\t\tTranslatorErrorCode.ResponseUnsupported,\n\t\t\t`Message action ${message.action} not translatable from ${message.target.service} yet.`,\n\t\t));\n\t}\n\n\t/**\n\t * Find the generic name for a provided event.\n\t * @param event  Event to analyse.\n\t * @returns      Generic name for the event.\n\t */\n\tpublic eventIntoMessageType(event: MessengerEvent): string {\n\t\treturn _.findKey(this.eventEquivalencies, (value: string[]) => {\n\t\t\treturn _.includes(value, event.type);\n\t\t}) || 'Unrecognised event';\n\t}\n\n\t/**\n\t * Find the specific events to listen to for a generic event type.\n\t * @param type  Generic name for the event.\n\t * @returns     A list of specific events to listen to.\n\t */\n\tpublic messageTypeIntoEventTypes(type: string): string[] {\n\t\treturn this.eventEquivalencies[type];\n\t}\n\n\t/**\n\t * Find all the events this translator understands.\n\t * @returns  The list of specific event names understood.\n\t */\n\tpublic getAllEventTypes(): string[] {\n\t\treturn _.flatMap(this.eventEquivalencies);\n\t}\n\n\t/**\n\t * Promise to convert a provided service specific event into messenger's standard form.\n\t * @param event  Service specific event, straight out of the ServiceListener.\n\t * @returns      Promise that resolves to the standard form of the message.\n\t */\n\tpublic abstract eventIntoMessage(event: ServiceScaffoldEvent): Promise<MessengerEvent>\n\n\t/**\n\t * Promise to provide emitter construction details for a provided message.\n\t * @param message  Message information, used to retrieve username\n\t * @returns        Promise that resolves to the details required to construct an emitter.\n\t */\n\tpublic abstract messageIntoEmitterConstructor(message: TransmitInformation): Promise<object>\n\n\t/**\n\t * Populate the listener constructor with details from the more generic constructor.\n\t * Provided since the connectionDetails might need to be parsed from JSON and the server details might be instantiated.\n\t * @param connectionDetails  Construction details for the service, probably 'inert', ie from JSON.\n\t * @param genericDetails     Details from the construction of the messenger.\n\t * @returns                  Connection details with the value merged in.\n\t */\n\tpublic abstract mergeGenericDetails(connectionDetails: object, genericDetails: MessengerConstructor): object\n}\n"],"sourceRoot":"../../../../lib"}