{"version":3,"sources":["initRepo.ts"],"names":[],"mappings":"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","file":"initRepo.js","sourcesContent":["/*\nCopyright 2016 Resin.io\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// Import most things with types if possible.\nimport Opts = require('node-getopt');\nimport * as _ from 'lodash';\nimport * as Promise from 'bluebird';\nconst GithubApi = require('github');\n\n// Arguments determine which bot type we want to use.\nconst getopt = new Opts([\n    [ 'r',\t'repository=',  'The repo on Github to init. Must be fullname, eg. `<owner>/<repo>`'],\n    [ 'u',\t'user=',        'Username of an admin for the repo'],\n    [ 'p',\t'password=',    'Password of an admin for the repo'],\n    [ 'h',\t'help',         'This help message']\n]);\n\ngetopt.setHelp(`\nUsage: ${process.argv[1].split('/').slice(-1)} [OPTIONS]\n[[OPTIONS]]\n`);\n\n// No options, no run.\nconst opt = getopt.parse(process.argv.slice(2))\nif (opt.options['help'] || Object.keys(opt.options).length === 0) {\n    console.log(getopt.getHelp());\n    process.exit(0)\n}\n\n// Ensure we have a user, password and repo.\nif (!opt.options['user']) {\n    console.log('\\tPlease provide the username of an admin with `--user`');\n    process.exit(0);\n}\nif (!opt.options['password']) {\n    console.log('\\tPlease provide the password of an admin with `--password`');\n    process.exit(0);\n}\nif (!opt.options['repository']) {\n    console.log('\\tPlease provide a repository to initialise with `--repository`');\n    process.exit(0);\n}\n\n// Create new API instance and authenticate using the user\nconst githubApi = new GithubApi({\n    protocol: 'https',\n    host: 'api.github.com',\n    headers: {\n        'Accept': 'application/vnd.github.loki-preview+json'\n    },\n    Promise: Promise,\n    timeout: 5000\n});\n\ngithubApi.authenticate({\n    type: 'basic',\n    username: opt.options['user'],\n    password: opt.options['password']\n});\n\n// Get the master branch of the named repo.\nconst owner = opt.options['repository'].split('/')[0];\nconst repo = opt.options['repository'].split('/')[1];\n\nif (!owner || !repo) {\n    console.log('\\tThe repository name passed in was invalid')\n    console.log(getopt.getHelp());\n    process.exit(0)\n}\n\n// We need to get both the status checks and the review checks.\nconsole.log(`\\tChecking repository ${opt.options['repository']}...`)\nPromise.all([\n    githubApi.repos.getProtectedBranchRequiredStatusChecks({\n        owner: owner,\n        repo: repo,\n        branch: 'master'\n    }),\n    githubApi.repos.getProtectedBranchPullRequestReviewEnforcement({\n        owner: owner,\n        repo: repo,\n        branch: 'master'\n    })\n]).then((protections: any[]) => {\n    const statusChecks = protections[0];\n    const reviewChecks = protections[1];\n    let contexts = statusChecks.contexts;\n\n    // Check the protection currently on the branch, if any of this is missing we'll blanket\n    // update.\n    // Note we don't currently specifically force review checks on Admins.\n    // This is for critical firefighting, which occasionally happens.\n    if (!statusChecks || !contexts) {\n        return { update: true, contexts };\n    }\n    // Admins should be included in status checks.\n    if (!statusChecks.include_admins) {\n        return { update: true, contexts };\n    }\n    // If the Versionist status isn't included, make sure it is!\n    // We play with the contexts object to ensure we don't blow away any other valid contexts.\n    if ((statusChecks.contexts.length < 1) || !_.includes(contexts, 'Versionist')) {\n        // Ensure that the Versionist context is added.\n        if (!_.includes(statusChecks.context, 'Versionist')) {\n            statusChecks.contexts.push('Versionist');\n        }\n        return { update: true, contexts };\n    }\n    // Needs to be review checks, and admins should *not* be included.\n    if (!reviewChecks || reviewChecks.include_admins) {\n        return { update: true, contexts };\n    }\n\n    return { update: false, contexts };\n}).catch((err: Error) => {\n    // The returned message is a bit non-standard, so convert.\n    const errMessage: any = JSON.parse(err.message);\n    if (errMessage.message !== 'Branch not protected') {\n        throw err;\n    }\n\n    return { update: true };\n}).then((updateObj: any) => {\n    // We need to specifically update the checks for the branch. Do the lot, regardless\n    // of how many were set before.\n    if (updateObj.update) {\n        if (!updateObj.contexts) {\n            updateObj.contexts = [ 'Versionist' ];\n        }\n        const statusChecks = {\n            strict: true,\n            include_admins: true,\n            contexts: updateObj.contexts\n        };\n        const reviewChecks = {\n            include_admins: false\n        };\n        return githubApi.repos.updateBranchProtection({\n            owner: owner,\n            repo: repo,\n            branch: 'master',\n            required_status_checks: statusChecks,\n            required_pull_request_reviews: reviewChecks,\n            restrictions: null\n        }).then(() => {\n            console.log(`\\tBranch protection for ${opt.options['repository']} have been set`);\n        });\n    }\n\n    console.log(`\\tBranch protection for ${opt.options['repository']} is already correct`);\n}).catch((err: Error) => {\n    console.log(`\\tCouldn't update the protection rights for ${opt.options['repository']}:`);\n    console.log(err.message);\n});\n"],"sourceRoot":"../lib"}